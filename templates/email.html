<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>E-Mail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(130deg, #11141a, #293243);
      }
      .shell {
        width: min(1100px, 96vw);
        margin: 20px auto;
      }
      .head {
        background: linear-gradient(120deg, #b61f1f, #8e1414);
        color: #fff;
        border-radius: 12px;
        padding: 16px;
      }
      .cardx {
        background: #f7f7f7;
        border-radius: 12px;
        padding: 14px;
        margin-top: 12px;
      }
      .mail-body {
        white-space: pre-wrap;
        max-height: 220px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <section class="head d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <h1 class="h4 m-0">Interne E-Mail</h1>
          <div class="small">Nachrichten zwischen Mitarbeitenden</div>
        </div>
        <div class="d-flex gap-2">
          <a href="/menu" class="btn btn-light btn-sm">Zurueck zum Hauptmenue</a>
          <form method="post" action="/presse/logout" class="m-0">
            <button type="submit" class="btn btn-dark btn-sm">Abmelden</button>
          </form>
        </div>
      </section>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mt-2">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} mb-2">{{ message }}</div>
          {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <section class="cardx">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <div><strong>Von:</strong> {{ username }}{% if display_name %} - {{ display_name }}{% endif %}</div>
            {% if server_name %}<div><strong>Server:</strong> {{ server_name }}{% if server_code %} ({{ server_code }}){% endif %}</div>{% endif %}
          </div>
          <span class="badge text-bg-danger">{{ unread_count }} ungelesen</span>
        </div>
      </section>

      <section class="cardx">
        <h2 class="h6">Neue E-Mail senden</h2>
        <form method="post">
          <input type="hidden" name="action" value="send">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Empfaenger</label>
              <select class="form-select" name="recipient_username" required>
                <option value="">Bitte waehlen</option>
                {% for u in recipients %}
                <option value="{{ u.username }}">{{ u.username }}{% if u.display_name %} - {{ u.display_name }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label">Betreff</label>
              <input class="form-control" name="subject" maxlength="160" required>
            </div>
            <div class="col-12">
              <label class="form-label">Nachricht</label>
              <textarea class="form-control" name="body" rows="5" maxlength="4000" required></textarea>
            </div>
            <div class="col-12 d-grid d-md-flex justify-content-md-end">
              <button class="btn btn-primary" type="submit">Senden</button>
            </div>
          </div>
        </form>
      </section>

      <section class="cardx">
        <h2 class="h6 mb-2">Posteingang</h2>
        {% for msg in inbox %}
        <div class="border rounded p-2 bg-white mb-2">
          <div class="d-flex justify-content-between flex-wrap gap-2">
            <div>
              <strong>{{ msg.subject }}</strong>
              <div class="small text-muted">
                Von: {{ msg.sender_username }}{% if msg.sender_display_name %} - {{ msg.sender_display_name }}{% endif %}
                | Eingang: {{ msg.created_at_label }}
                | Status: {{ msg.read_at_label }}
              </div>
            </div>
            {% if msg.is_unread %}
            <form method="post" class="m-0">
              <input type="hidden" name="action" value="mark_read">
              <input type="hidden" name="message_id" value="{{ msg.id }}">
              <button class="btn btn-outline-success btn-sm" type="submit">Als gelesen markieren</button>
            </form>
            {% endif %}
          </div>
          <hr class="my-2">
          <div class="mail-body">{{ msg.body }}</div>
        </div>
        {% else %}
        <p class="text-muted m-0">Keine E-Mails im Posteingang.</p>
        {% endfor %}
      </section>

      <section class="cardx">
        <h2 class="h6 mb-2">Gesendet</h2>
        {% for msg in sent %}
        <div class="border rounded p-2 bg-white mb-2">
          <strong>{{ msg.subject }}</strong>
          <div class="small text-muted">
            An: {{ msg.recipient_username }}{% if msg.recipient_display_name %} - {{ msg.recipient_display_name }}{% endif %}
            | Gesendet: {{ msg.created_at_label }}
          </div>
          <hr class="my-2">
          <div class="mail-body">{{ msg.body }}</div>
        </div>
        {% else %}
        <p class="text-muted m-0">Noch nichts gesendet.</p>
        {% endfor %}
      </section>
    </main>
  </body>
</html>
