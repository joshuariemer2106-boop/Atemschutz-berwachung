<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>System Einstellungen</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { margin:0; min-height:100vh; background:linear-gradient(140deg,#1a1e26,#2c3440); display:flex; align-items:center; justify-content:center; }
      .box { width:min(860px,95vw); background:#f5f5f5; border-radius:14px; padding:24px; box-shadow:0 18px 40px rgba(0,0,0,.35); }
    </style>
  </head>
  <body>
    <main class="box">
      <h1 class="h3 mb-2">System Einstellungen</h1>
      <p class="text-muted">Zentrale Verwaltung für Module, Rollen und Webhooks.</p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="post" action="/owner/settings" class="mb-4" enctype="multipart/form-data">
        <input type="hidden" name="action" value="save_webhooks">
        <h2 class="h5 mt-2">Atemschutz Webhooks</h2>
        <div class="mb-2">
          <label class="form-label">Atemschutz Webhook URL 1 (Pflicht)</label>
          <input name="asw_webhook_url_1" class="form-control" required value="{{ settings.get('asw_webhook_url_1', '') }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Atemschutz Webhook URL 2 (optional)</label>
          <input name="asw_webhook_url_2" class="form-control" value="{{ settings.get('asw_webhook_url_2', '') }}">
        </div>

        <h2 class="h5">Presse Webhooks</h2>
        <div class="mb-2">
          <label class="form-label">Presse Webhook URL 1 (Pflicht)</label>
          <input name="webhook_url_1" class="form-control" required value="{{ settings.get('webhook_url_1', '') }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Presse Webhook URL 2 (optional)</label>
          <input name="webhook_url_2" class="form-control" value="{{ settings.get('webhook_url_2', '') }}">
        </div>

        <h2 class="h5">Einsatzberichte Webhook</h2>
        <div class="mb-3">
          <label class="form-label">Einsatzberichte Webhook URL (optional)</label>
          <input name="einsatzberichte_webhook_url" class="form-control" value="{{ settings.get('einsatzberichte_webhook_url', '') }}">
        </div>

        <h2 class="h5">Hauptmenü Design</h2>
        <div class="mb-3">
          <label class="form-label">Hintergrundbild URL (optional)</label>
          <input name="menu_background_url" class="form-control" placeholder="https://..." value="{{ settings.get('menu_background_url', '') }}">
          <div class="form-text">Wenn leer, wird der Standard-Hintergrund verwendet. Ein Upload überschreibt die URL.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Hintergrundbild hochladen (optional)</label>
          <input type="file" name="menu_background_file" class="form-control" accept="image/png,image/jpeg,image/jpg,image/gif">
          {% if settings.get('menu_background_url', '') %}
          <div class="form-text">Aktuell gesetzt: <a href="{{ settings.get('menu_background_url') }}" target="_blank">Hintergrund öffnen</a></div>
          {% endif %}
        </div>

        <button class="btn btn-dark" type="submit">Speichern</button>
        <a href="/menu" class="btn btn-outline-secondary">Zurück</a>
      </form>

      <hr>
      <h2 class="h5">Rollen und Zugriffe</h2>
      <p class="text-muted mb-2">Owner kann Rollen anlegen und festlegen, wer worauf zugreifen darf.</p>

      {% for role_key, cfg in role_configs.items() %}
        {% if role_key != 'owner' %}
        <form method="post" action="/owner/settings" class="border rounded p-3 mb-2 bg-white">
          <input type="hidden" name="action" value="save_role">
          <input type="hidden" name="role_key" value="{{ role_key }}">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Rollen-ID</label>
              <input class="form-control" value="{{ role_key }}" disabled>
            </div>
            <div class="col-md-8">
              <label class="form-label">Anzeigename</label>
              <input name="role_label" class="form-control" value="{{ cfg.label }}" required>
            </div>
            <div class="col-12">
              <label class="form-label">Rechte</label>
              <div class="d-flex flex-wrap gap-3">
                {% for perm_code, perm_label in permissions_catalog %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="{{ role_key }}_{{ perm_code }}" name="permissions" value="{{ perm_code }}" {% if perm_code in cfg.permissions %}checked{% endif %}>
                  <label class="form-check-label" for="{{ role_key }}_{{ perm_code }}">{{ perm_label }}</label>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          <button class="btn btn-outline-dark btn-sm mt-2" type="submit">Rolle speichern</button>
        </form>
        <form method="post" action="/owner/settings" class="mb-2">
          <input type="hidden" name="action" value="delete_role">
          <input type="hidden" name="role_key" value="{{ role_key }}">
          <button class="btn btn-outline-danger btn-sm" type="submit" onclick="return confirm('Rolle wirklich löschen?');">Rolle löschen</button>
        </form>
        {% endif %}
      {% endfor %}

      <form method="post" action="/owner/settings" class="border rounded p-3 bg-white">
        <input type="hidden" name="action" value="save_role">
        <h3 class="h6">Neue Rolle anlegen</h3>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Rollen-ID</label>
            <input name="role_key" class="form-control" placeholder="z.B. presse_mitglied" required>
          </div>
          <div class="col-md-8">
            <label class="form-label">Anzeigename</label>
            <input name="role_label" class="form-control" placeholder="z.B. Presse Mitglied" required>
          </div>
          <div class="col-12">
            <label class="form-label">Rechte</label>
            <div class="d-flex flex-wrap gap-3">
              {% for perm_code, perm_label in permissions_catalog %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="new_{{ perm_code }}" name="permissions" value="{{ perm_code }}">
                <label class="form-check-label" for="new_{{ perm_code }}">{{ perm_label }}</label>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        <button class="btn btn-dark btn-sm mt-2" type="submit">Neue Rolle speichern</button>
      </form>

      <hr>
      <h2 class="h5">Einsatzberichte Vorlagen</h2>
      <p class="text-muted mb-2">Owner kann Vorlagen erstellen, die in der Einsatzberichte-App genutzt werden.</p>

      <form method="post" action="/owner/settings" class="border rounded p-3 bg-white mb-2">
        <input type="hidden" name="action" value="save_report_template">
        <h3 class="h6">Neue Vorlage</h3>
        <div class="row g-2">
          <div class="col-md-5">
            <label class="form-label">Vorlagenname</label>
            <input name="template_title" class="form-control" required>
          </div>
          <div class="col-md-7">
            <label class="form-label">Vorlageninhalt</label>
            <textarea name="template_body" rows="3" class="form-control" required></textarea>
          </div>
        </div>
        <button class="btn btn-dark btn-sm mt-2" type="submit">Vorlage speichern</button>
      </form>

      {% for tpl in settings.get('einsatzbericht_templates', []) %}
      <form method="post" action="/owner/settings" class="border rounded p-3 bg-white mb-2">
        <input type="hidden" name="action" value="save_report_template">
        <input type="hidden" name="template_id" value="{{ tpl.id }}">
        <div class="row g-2">
          <div class="col-md-5">
            <label class="form-label">Vorlagenname</label>
            <input name="template_title" class="form-control" value="{{ tpl.title }}" required>
          </div>
          <div class="col-md-7">
            <label class="form-label">Vorlageninhalt</label>
            <textarea name="template_body" rows="3" class="form-control" required>{{ tpl.body }}</textarea>
          </div>
        </div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-outline-dark btn-sm" type="submit">Änderungen speichern</button>
        </div>
      </form>
      <form method="post" action="/owner/settings" class="mb-2">
        <input type="hidden" name="action" value="delete_report_template">
        <input type="hidden" name="template_id" value="{{ tpl.id }}">
        <button class="btn btn-outline-danger btn-sm" type="submit" onclick="return confirm('Vorlage wirklich löschen?');">Vorlage löschen</button>
      </form>
      {% endfor %}
    </main>
  </body>
</html>
